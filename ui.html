<style>
  /* Importa a fonte Inter do Google Fonts */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

  /* Reset e Configurações Globais */
  * {
    box-sizing: border-box;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    margin: 0;
    padding: 0;
    background-color: #EFEFEF; /* Background geral da área de conteúdo */
    color: #2D2D2D;
    /* Remove a barra de rolagem do body, o scroll será por área */
    overflow: hidden; 
  }

  /* --- Estrutura Principal --- */
  .plugin-wrapper {
    display: flex;
    flex-direction: column;
    height: 100vh; /* Ocupa toda a altura da janela do plugin */
  }
  
  /* --- 1. Área das Abas --- */
  .tabs-container {
    background-color: #FFFFFF;
    padding: 16px;
    border-bottom: 1px solid #AEAEAE;
    flex-shrink: 0; /* Impede que a área encolha */
  }

  .tabs {
    display: flex;
  }

  .tab {
    font-size: 14px;
    margin-right: 16px;
    cursor: pointer;
    font-weight: 400; /* Regular */
    color: #AEAEAE;
  }

  .tab.active {
    /* Estilo item selecionado */
    font-weight: 600; /* Semibold */
    color: #2D2D2D;
  }
  
  /* --- 2. Área de Conteúdo (Inputs) --- */
  .content-area {
    flex-grow: 1; /* Faz esta área ocupar todo o espaço restante */
    overflow-y: auto; /* Adiciona scroll apenas se o conteúdo transbordar */
    padding: 16px;
  }

  .container { /* Empty state */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    color: #5F5F5F;
    height: 100%;
  }
  .container p {
    margin: 0;
  }
  .container p:last-child {
    font-size: 12px;
    margin-top: 4px;
  }

  .text-list {
    width: 100%;
    text-align: left;
  }

  .frame-group {
    margin-bottom: 16px;
  }

  .frame-title {
    /* Label da caixa de texto */
    font-size: 13px;
    font-weight: 600; /* Bold */
    color: #2D2D2D;
    margin-bottom: 8px;
  }

  .input-wrapper {
    position: relative;
    width: 100%;
    margin-bottom: 8px;
  }

  input[type="text"] {
    width: 100%;
    padding: 12px 12px;
    padding-right: 32px; /* Espaço para o ícone de reset */
    border: 1px solid #AEAEAE;
    border-radius: 8px;
    box-sizing: border-box;
    background-color: #FFFFFF;
    transition: border-color 0.2s;

    /* Estilo do texto do input */
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 400; /* Regular */
    color: #5F5F5F;
  }
  input[type="text"]:focus {
    outline: none;
    border: 1px solid #2D2D2D;
  }

  .reset-icon {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    width: 16px;
    height: 16px;
    cursor: pointer;
    transition: opacity 0.1s, visibility 0.2s;
    visibility: hidden;
    color: #5F5F5F;
    opacity: 0.5 ;
  }
  .reset-icon:hover { opacity: 1; }
  .reset-icon.visible { visibility: visible; }
  
  /* --- 3. Área dos Botões --- */
  .footer {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    padding: 20px;
    background-color: #FFFFFF;
    border-top: 0.5px solid #AEAEAE; /* Linha divisória superior */
    flex-shrink: 0; /* Impede que a área encolha */
  }

  button {
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 600; /* Semibold */
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s, color 0.2s;
  }

  /* Botão Aplicar */
  button#apply {
    /* Padding para guiar o tamanho */
    padding: 12px 20px;
  }
  
  .arrow {
    margin-left: 8px; /* Espaçamento do texto para a seta */
    transition: color 0.2s;
  }

  /* Estado Ativado do Aplicar */
  button#apply {
    background: #2D2D2D;
    color: #FFFFFF;
  }

  /* Estado Desativado do Aplicar */
  button#apply:disabled {
    background: #DFDFDF;
    color: #5F5F5F;
    cursor: not-allowed;
  }

  .hidden {
    display: none;
  }

  .finder-section { margin-bottom: 16px; }
  .finder-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .finder-title { font-size: 13px; font-weight: 600; color: #2D2D2D; }
  .finder-nav { display: flex; align-items: center; gap: 8px; }
  .finder-nav span { font-size: 13px; color: #5F5F5F; min-width: 40px; text-align: center; }
  .finder-nav button { background-color: transparent; color: #5F5F5F; padding: 2px 6px; border: 1px solid #AEAEAE; border-radius: 4px; }
  .finder-nav button:disabled { color: #C1C1C1; border-color: #EFEFEF; cursor: not-allowed; }
  .finder-nav button:hover:not(:disabled) { background-color: #DFDFDF; }

  .finder-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
  }
  .finder-actions button {
    flex-grow: 1; /* Faz os botões ocuparem o espaço igualmente */
    padding: 10px;
  }
  #replace-single {
    background-color: #FFFFFF;
    color: #2D2D2D;
    border: 1px solid #AEAEAE;
  }
  #replace-all {
    background-color: #2D2D2D;
    color: #FFFFFF;
  }
  .finder-actions button:disabled {
    background: #DFDFDF;
    color: #5F5F5F;
    cursor: not-allowed;
    border-color: transparent;
  }
  #find-input {
    /* Adiciona espaço à direita para o botão não sobrepor o texto */
    padding-right: 40px; 
  }
  #case-sensitive-toggle {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background-color: transparent;
    border: 1px solid transparent;
    border-radius: 4px;
    padding: 4px;
    color: #AEAEAE;
    font-size: 14px;
    line-height: 1;
    font-weight: 700;
  }
  #case-sensitive-toggle:hover {
    background-color: #f0f0f0;
  }
  #case-sensitive-toggle.active {
    background-color: #e0e0e0;
    color: #2D2D2D;
  }

  .feedback-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #e0f2fe; /* Um azul bem claro */
    color: #0c4a6e; /* Um azul escuro */
    padding: 8px 12px;
    border-radius: 6px;
    margin-top: 12px;
    font-size: 13px;
  }

  #undo-button {
    background: none;
    border: 1px solid #0ea5e9; /* Azul */
    color: #0284c7; /* Azul mais escuro */
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  #undo-button:hover {
    background-color: #f0f9ff;
  }

</style>

<div class="plugin-wrapper">
  <div class="tabs-container">
    <div class="tabs">
      <div class="tab active" id="tab-textos">Textos</div>
      <div class="tab" id="tab-frames">Frames</div>
      <div class="tab" id="tab-finder">Finder</div>
    </div>
  </div>

  <div class="content-area">
    <div id="empty-state" class="container">
      <p>Nenhum texto selecionado</p>
      <p>Selecione segurando Ctrl+Shift</p>
    </div>
    <div id="text-list-container" class="text-list hidden"></div>

    <div id="finder-container" class="hidden">
      <div class="finder-section">
        <div class="finder-header">
          <div class="finder-title">Finder</div>
          <div class="finder-nav">
            <button id="finder-prev" disabled>&lt;</button>
            <span id="finder-counter">0/0</span>
            <button id="finder-next" disabled>&gt;</button>
          </div>
        </div>
        <div class="input-wrapper">
          <input type="text" id="find-input" placeholder="O que você procura?">
          <button id="case-sensitive-toggle">Aa</button>
        </div>
      </div>
      <div class="finder-section">
        <div class="finder-title">Replace</div>
        <div class="input-wrapper">
          <input type="text" id="replace-input" placeholder="Substituir com...">
        </div>
        <div class="finder-actions">
          <button id="replace-single" disabled>Replace</button>
          <button id="replace-all" disabled>Replace All</button>
        </div>

        <div id="feedback-container" class="feedback-container hidden">
            <span id="feedback-message"></span>
            <button id="undo-button">Desfazer</button>
        </div>

      </div>
      <div class="finder-section">
        <div class="finder-title">Preview</div>
        <div class="input-wrapper">
          <textarea id="preview-text" rows="4" readonly style="background-color: #F5F5F5; color: #5F5F5F;"></textarea>
        </div>
      </div>
    </div>
  </div>

  <div class="footer hidden"> <button id="apply" disabled>Aplicar<span class="arrow">→</span></button>
  </div>
</div>

<div class="plugin-wrapper"></div>

<script>
  const feedbackContainer = document.getElementById('feedback-container');
  const feedbackMessage = document.getElementById('feedback-message');
  const undoButton = document.getElementById('undo-button');
  // Referências de elementos existentes
  const tabTextos = document.getElementById('tab-textos');
  const tabFrames = document.getElementById('tab-frames');
  const emptyState = document.getElementById('empty-state');
  const textListContainer = document.getElementById('text-list-container');
  const applyButton = document.getElementById('apply');
  const footer = document.querySelector('.footer');

  // Referências do Finder
  const tabFinder = document.getElementById('tab-finder');
  const finderContainer = document.getElementById('finder-container');
  const findInput = document.getElementById('find-input');
  const finderCounter = document.getElementById('finder-counter');
  const finderPrev = document.getElementById('finder-prev');
  const finderNext = document.getElementById('finder-next');
  
  const replaceInput = document.getElementById('replace-input');
  const previewText = document.getElementById('preview-text');
  const replaceSingleBtn = document.getElementById('replace-single');
  const replaceAllBtn = document.getElementById('replace-all');
  const caseSensitiveToggle = document.getElementById('case-sensitive-toggle');

  // Variáveis de estado
  let currentMode = 'textos';
  let lastReceivedData = null;
  let currentOriginalNodeText = ''; // Guarda o texto original do nó em foco
  let searchResultsCount = 0;
  let isCaseSensitive = false;

  function hideFeedback() {
    feedbackContainer.classList.add('hidden');
  }

  // --- LÓGICA DE TROCA DE ABAS ---
  function setMode(mode) {
    currentMode = mode;
    // Atualiza o visual das abas
    tabTextos.classList.toggle('active', mode === 'textos');
    tabFrames.classList.toggle('active', mode === 'frames');
    tabFinder.classList.toggle('active', mode === 'finder');
    
    // Mostra/esconde o botão 'Aplicar' e o container principal
    const isFinderMode = mode === 'finder';
    footer.classList.toggle('hidden', isFinderMode); // Esconde todo o footer
    finderContainer.classList.toggle('hidden', !isFinderMode);
    textListContainer.classList.toggle('hidden', isFinderMode);
    emptyState.classList.toggle('hidden', isFinderMode);

    // Se não for finder, renderiza o conteúdo da seleção
    if (!isFinderMode) {
      if (lastReceivedData) {
        renderContent(lastReceivedData);
      }
      applyButton.disabled = true;
    }
  }

  tabTextos.onclick = () => setMode('textos');
  tabFrames.onclick = () => setMode('frames');
  tabFinder.onclick = () => setMode('finder');

  // --- FUNÇÕES DE RENDERIZAÇÃO ---
  function renderContent(data) {
    if (currentMode === 'textos') {
      renderTextView(data.textData);
    } else {
      renderFrameView(data.frameData);
    }
  }

  function renderTextView(textData) {
    const frameIds = Object.keys(textData);
    if (frameIds.length === 0) {
      // A LINHA PROBLEMÁTICA ESTAVA AQUI E FOI REMOVIDA
      emptyState.querySelector('p:first-child').textContent = 'Nenhum texto selecionado';
      emptyState.classList.remove('hidden');
      textListContainer.classList.add('hidden');
      footer.classList.add('hidden'); // Garante que o footer também some
    } else {
      emptyState.classList.add('hidden');
      textListContainer.classList.remove('hidden');
      footer.classList.remove('hidden'); // Mostra o footer se houver itens
      textListContainer.innerHTML = ''; // Limpa a lista
      for (const frameId of frameIds) {
        const frameData = textData[frameId];
        const frameGroup = document.createElement('div');
        frameGroup.className = 'frame-group';
        const title = document.createElement('div');
        title.className = 'frame-title';
        title.textContent = frameData.frameName;
        frameGroup.appendChild(title);
        for (const textNode of frameData.textNodes) {
          // O resto do código continua igual...
          const wrapper = document.createElement('div');
          wrapper.className = 'input-wrapper';
          const input = document.createElement('input');
          input.type = 'text';
          input.value = textNode.characters;
          input.dataset.nodeId = textNode.nodeId;
          input.dataset.originalText = textNode.characters;
          const resetIcon = document.createElement('img');
          resetIcon.className = 'reset-icon';
          resetIcon.src = "data:image/svg+xml,%3Csvg%20width='16'%20height='15'%20viewBox='0%200%2016%2015'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3E%3Cpath%20d='M3.72225%201.5L1%203.75M1%203.75L3.72225%206.375M1%203.75H9.94219C12.6189%203.75%2014.892%205.8575%2014.9962%208.4375C15.1067%2011.1637%2012.7706%2013.5%209.94219%2013.5H3.33258'%20stroke='%235F5F5F'%20stroke-width='2'%20stroke-linecap='round'%20stroke-linejoin='round'/%3E%3C/svg%3E";
          wrapper.appendChild(input);
          wrapper.appendChild(resetIcon);
          frameGroup.appendChild(wrapper);
        }
        textListContainer.appendChild(frameGroup);
      }
    }
  }

  function renderFrameView(frameData) {
    if (frameData.length === 0) {
      // A LINHA PROBLEMÁTICA ESTAVA AQUI E FOI REMOVIDA
      emptyState.querySelector('p:first-child').textContent = 'Nenhum frame selecionado';
      emptyState.classList.remove('hidden');
      textListContainer.classList.add('hidden');
      footer.classList.add('hidden'); // Garante que o footer também some
    } else {
      emptyState.classList.add('hidden');
      textListContainer.classList.remove('hidden');
      footer.classList.remove('hidden'); // Mostra o footer se houver itens
      textListContainer.innerHTML = ''; // Limpa a lista
      const frameGroup = document.createElement('div');
      frameGroup.className = 'frame-group';
      for (const frameNode of frameData) {
        // O resto do código continua igual...
        const wrapper = document.createElement('div');
        wrapper.className = 'input-wrapper';
        const input = document.createElement('input');
        input.type = 'text';
        input.value = frameNode.name;
        input.dataset.nodeId = frameNode.nodeId;
        input.dataset.originalText = frameNode.name;
        const resetIcon = document.createElement('img');
        resetIcon.className = 'reset-icon';
        resetIcon.src = "data:image/svg+xml,%3Csvg%20width='16'%20height='15'%20viewBox='0%200%2016%2015'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3E%3Cpath%20d='M3.72225%201.5L1%203.75M1%203.75L3.72225%206.375M1%203.75H9.94219C12.6189%203.75%2014.892%205.8575%2014.9962%208.4375C15.1067%2011.1637%2012.7706%2013.5%209.94219%2013.5H3.33258'%20stroke='%235F5F5F'%20stroke-width='2'%20stroke-linecap='round'%20stroke-linejoin='round'/%3E%3C/svg%3E";
        wrapper.appendChild(input);
        wrapper.appendChild(resetIcon);
        frameGroup.appendChild(wrapper);
      }
      textListContainer.appendChild(frameGroup);
    }
  }

  function updatePreview() {
    const findValue = findInput.value;
    const replaceValue = replaceInput.value;
    if (currentOriginalNodeText === '' || findValue === '') {
      previewText.value = currentOriginalNodeText;
    } else {
      // Usa RegExp para o preview refletir a opção de case-sensitive
      const regex = new RegExp(findValue, isCaseSensitive ? '' : 'i');
      previewText.value = currentOriginalNodeText.replace(regex, replaceValue);
    }
  }

  function updateButtonStates() {
    const hasResults = searchResultsCount > 0;
    const hasReplaceText = replaceInput.value !== '';
    replaceSingleBtn.disabled = !(hasResults && hasReplaceText);
    replaceAllBtn.disabled = !(hasResults && hasReplaceText);
  }
  
  function updateFinderUI(index, count, nodeText = '') {
    searchResultsCount = count;
    currentOriginalNodeText = nodeText;

    const hasResults = count > 0;
    finderCounter.textContent = `${hasResults ? index + 1 : 0}/${count}`;
    finderPrev.disabled = !hasResults;
    finderNext.disabled = !hasResults;

    updatePreview();
    updateButtonStates();
  }
  
  function resetFinderUI() {
    findInput.value = '';
    replaceInput.value = '';
    currentOriginalNodeText = '';
    updateFinderUI(-1, 0);
  }

  function triggerSearch() {
    if (findInput.value.trim() === '') {
      updateFinderUI(-1, 0, '');
      return;
    }
    parent.postMessage({
      pluginMessage: {
        type: 'find-text',
        query: findInput.value,
        isCaseSensitive: isCaseSensitive // Envia o estado do botão
      }
    }, '*');
  }

  // --- OUVINTE PRINCIPAL DE MENSAGENS ---
  window.onmessage = (event) => {
    const msg = event.data.pluginMessage;

    // Esconde a mensagem de 'Desfazer' em quase todas as ações para limpar a UI
    if (msg.type !== 'replace-success') {
        hideFeedback();
    }
    
    switch (msg.type) {
        case 'selectionChange':
            lastReceivedData = msg;
            if (currentMode !== 'finder') {
                applyButton.disabled = true;
                renderContent(lastReceivedData);
            }
            break;
        
        case 'search-result':
        case 'navigation-update':
            updateFinderUI(msg.index, msg.count, msg.nodeText);
            break;

        case 'replace-success':
            feedbackMessage.textContent = `${msg.count} ${msg.count > 1 ? 'itens substituídos' : 'item substituído'}.`;
            feedbackContainer.classList.remove('hidden');
            
            if (msg.allReplaced) {
                // Se foi 'Replace All', limpa a UI do finder
                resetFinderUI();
            } else if (msg.updatedNode) {
                // Se foi 'Replace Single', apenas atualiza a UI com os novos dados
                updateFinderUI(msg.updatedNode.index, msg.updatedNode.count, msg.updatedNode.nodeText);
            }
            break;
            
        case 'all-replace-success': // Este caso pode ser mantido ou removido se a lógica de 'replace-success' cobrir tudo
            resetFinderUI();
            break;

        case 'hide-undo':
             hideFeedback();
             break;

        case 'undo-complete':
            hideFeedback();
            // Após desfazer, é bom re-disparar a busca para atualizar o contador
            triggerSearch();
            break;
    }
  };

  undoButton.onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'undo-last-change' } }, '*');
  };


  // Adicione a chamada `hideFeedback()` em eventos que indicam uma nova ação do usuário
  findInput.addEventListener('input', () => {
      hideFeedback();
      triggerSearch();
  });
  replaceInput.addEventListener('input', () => {
      hideFeedback();
      updatePreview();
      updateButtonStates();
  });
  
  // --- LÓGICA DOS EVENTOS DE UI ---
  textListContainer.addEventListener('input', (event) => {
    if (event.target.tagName === 'INPUT') {
      const input = event.target;
      const resetIcon = input.nextElementSibling;
      let hasChanges = false;

      // Mostra/esconde ícone de reset individual
      if (input.value !== input.dataset.originalText) {
        resetIcon.classList.add('visible');
      } else {
        resetIcon.classList.remove('visible');
      }
      
      // Verifica se qualquer input foi alterado para habilitar o botão "Aplicar"
      const allInputs = textListContainer.querySelectorAll('input[type="text"]');
      for (const i of allInputs) {
          if (i.value !== i.dataset.originalText) {
              hasChanges = true;
              break; // Otimização: para a verificação assim que achar a primeira mudança
          }
      }

      applyButton.disabled = !hasChanges;
    }
  });

  textListContainer.addEventListener('click', (event) => {
    const resetIcon = event.target.closest('.reset-icon');
    if (resetIcon) {
      const wrapper = resetIcon.parentElement;
      const input = wrapper.querySelector('input');
      
      input.value = input.dataset.originalText;
      resetIcon.classList.remove('visible');

      // Dispara um evento de input para revalidar o estado do botão "Aplicar"
      input.dispatchEvent(new Event('input', { bubbles: true }));
    }
  });

  // CORREÇÃO 1: Removida a função de clique do botão #cancel, pois ele não existe.
  /*
  cancelButton.onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
  }
  */

  applyButton.onclick = () => {
    const inputs = textListContainer.querySelectorAll('input[type="text"]');
    const changes = [];
    
    inputs.forEach(input => {
        // Envia apenas os dados que foram realmente alterados
        if (input.value !== input.dataset.originalText) {
            if (currentMode === 'textos') {
                changes.push({ nodeId: input.dataset.nodeId, newText: input.value });
            } else { // Modo Frames
                changes.push({ nodeId: input.dataset.nodeId, newName: input.value });
            }
        }
    });

    if (changes.length > 0) {
        const messageType = currentMode === 'textos' ? 'apply-changes' : 'apply-frame-name-changes';
        parent.postMessage({ pluginMessage: { type: messageType, data: changes } }, '*');
    }

    // Reseta o estado do botão e atualiza o "texto original" dos inputs
    applyButton.disabled = true;
    inputs.forEach(input => {
      input.dataset.originalText = input.value;
      const resetIcon = input.nextElementSibling;
      if (resetIcon) {
        resetIcon.classList.remove('visible');
      }
    });

    document.addEventListener('keydown', (event) => {
      const isEnter = event.key === 'Enter' || event.keyCode === 13;

      // Verifica se o foco está em um input de texto e se o botão "Aplicar" está habilitado
      if (isEnter && document.activeElement.tagName === 'INPUT' && !applyButton.disabled) {
        applyButton.click();
      }
    });

  }

  findInput.addEventListener('input', triggerSearch);
  replaceInput.addEventListener('input', () => {
    updatePreview();
    updateButtonStates();
  });
  
  caseSensitiveToggle.onclick = () => {
    isCaseSensitive = !isCaseSensitive; // Inverte o estado
    caseSensitiveToggle.classList.toggle('active', isCaseSensitive); // Atualiza a UI
    triggerSearch(); // Refaz a busca com a nova configuração
  };

  finderNext.onclick = () => { parent.postMessage({ pluginMessage: { type: 'navigate', direction: 'next' } }, '*'); };
  finderPrev.onclick = () => { parent.postMessage({ pluginMessage: { type: 'navigate', direction: 'prev' } }, '*'); };

  replaceSingleBtn.onclick = () => {
    parent.postMessage({ 
      pluginMessage: { 
        type: 'replace-single',
        findText: findInput.value,
        replaceText: replaceInput.value,
        isCaseSensitive: isCaseSensitive // Envia o estado
      } 
    }, '*');
  };

  replaceAllBtn.onclick = () => {
    parent.postMessage({ 
      pluginMessage: { 
        type: 'replace-all',
        findText: findInput.value,
        replaceText: replaceInput.value,
        isCaseSensitive: isCaseSensitive // Envia o estado
      } 
    }, '*');
  };

  // Inicialização
  updateButtonStates();
</script>